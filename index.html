<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏´‡∏°‡∏π‡πÄ‡∏•‡∏µ‡∏¢‡∏á‡πÄ‡∏à‡πä‡∏ô‡πâ‡∏≠‡∏á</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #fefefe; }
    h1, h3, h4 { text-align: center; }
    .menu { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .item { background: #e0f7fa; padding: 10px; border-radius: 10px; cursor: pointer; text-align: center; }
    .item:hover { background: #b2ebf2; }
    .summary { margin-top: 20px; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; }
    .bill, .history, .report { white-space: pre-wrap; background: #f1f8e9; padding: 10px; border-radius: 10px; margin-top: 10px; }
    input[type="number"] { padding: 8px; font-size: 16px; width: 100px; text-align: center; }
    label { font-weight: bold; }
  </style>
</head>
<body>
<button onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
<button onclick="showPendingOrders()">üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
<div class="history" id="pendingList"></div>
<h1>POS ‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß</h1>

<div style="text-align: center; margin-bottom: 10px;">
  <label>‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label>
  <input type="number" id="tableNumber" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" />
</div>

<div class="menu" id="menu"></div>

<div class="summary">
  <h3>‡∏£‡∏ß‡∏°: <span id="total">0</span> ‡∏ö‡∏≤‡∏ó</h3>
  <button onclick="checkout()">‚úÖ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
  <button onclick="undoItem()">‚Ü©Ô∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
  <button onclick="resetAll()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  <div class="bill" id="bill"></div>
  <h4>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="sales">0</span> ‡∏ö‡∏≤‡∏ó</h4>
  <button onclick="showHistory()">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
  <button onclick="exportCSV()">üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
  <button onclick="showReport()">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏ï‡πä‡∏∞</button>
  <div class="history" id="history"></div>
  <div class="report" id="report"></div>
</div>

<script>
let pendingOrders = {};
const menuItems = [
  { name: "‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡∏´‡∏°‡∏π‡πÄ‡∏•‡∏µ‡∏¢‡∏á", price: 50 },
  { name: "‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏´‡πâ‡∏á", price: 40 },
  { name: "‡πÄ‡∏Å‡∏≤‡πÄ‡∏´‡∏•‡∏≤", price: 50 },
  { name: "‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤", price: 10 },
  { name: "‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°", price: 15 },
];

let order = [];
let salesTotal = Number(localStorage.getItem("salesTotal")) || 0;
let historyData = JSON.parse(localStorage.getItem("historyData") || "[]");

const menuDiv = document.getElementById("menu");
const totalSpan = document.getElementById("total");
const salesSpan = document.getElementById("sales");
const billDiv = document.getElementById("bill");
const historyDiv = document.getElementById("history");
const reportDiv = document.getElementById("report");
const tableInput = document.getElementById("tableNumber");

salesSpan.textContent = salesTotal;

menuItems.forEach(item => {
  const div = document.createElement("div");
  div.className = "item";
  div.textContent = `${item.name} - ${item.price} ‡∏ö‡∏≤‡∏ó`;
  div.onclick = () => {
    order.push(item);
    updateTotal();
  };
  menuDiv.appendChild(div);
});

function updateTotal() {
  const total = order.reduce((sum, item) => sum + item.price, 0);
  totalSpan.textContent = total;
  const tableNo = tableInput.value.trim() || "-";
  let text = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ ${tableNo}\n`;
  order.forEach(item => {
    text += `- ${item.name} (${item.price} ‡∏ö‡∏≤‡∏ó)\n`;
  });
  text += `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ö‡∏≤‡∏ó`;
  billDiv.textContent = text;
}

function checkout() {
  const tableNo = tableInput.value.trim();
  if (!tableNo) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏¥‡∏ô");
    return;
  }
  if (order.length === 0) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á");
    return;
  }
  const time = new Date().toLocaleString("th-TH");
  const total = order.reduce((sum, item) => sum + item.price, 0);

  billDiv.textContent = `‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÇ‡∏ï‡πä‡∏∞ ${tableNo})\n` +
    order.map(i => `- ${i.name} (${i.price} ‡∏ö‡∏≤‡∏ó)`).join("\n") +
    `\n‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ö‡∏≤‡∏ó\n‡πÄ‡∏ß‡∏•‡∏≤: ${time}`;

  historyData.push({ table: tableNo, items: [...order], total, time });
  salesTotal += total;
  localStorage.setItem("salesTotal", salesTotal);
  localStorage.setItem("historyData", JSON.stringify(historyData));

  fetch("https://script.google.com/macros/s/AKfycbwi4dZUNFJabRap4erLWBumtUSzi0szMuRLZvFjnXsmt9VRN2ZeEi_txAfFtJ45NlysWQ/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      table: tableNo,
      items: order.map(i => i.name),
      total: total
    })
  });

  salesSpan.textContent = salesTotal;
  order = [];
  updateTotal();
  historyDiv.textContent = "";
  reportDiv.textContent = "";
  delete pendingOrders[tableNo];
}

function undoItem() {
  if (order.length > 0) {
    order.pop();
    updateTotal();
  }
}

function resetAll() {
  if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
    localStorage.removeItem("salesTotal");
    localStorage.removeItem("historyData");
    order = [];
    salesTotal = 0;
    historyData = [];
    updateTotal();
    salesSpan.textContent = "0";
    billDiv.textContent = "";
    historyDiv.textContent = "";
    reportDiv.textContent = "";
  }
}

function showHistory() {
  if (historyData.length === 0) {
    historyDiv.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢";
    return;
  }
  let text = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢:\n";
  historyData.slice().reverse().forEach((r, i) => {
    text += `\n#${historyData.length - i} | ‡πÇ‡∏ï‡πä‡∏∞ ${r.table} | ‡πÄ‡∏ß‡∏•‡∏≤: ${r.time}\n`;
    r.items.forEach(it => text += `- ${it.name} (${it.price} ‡∏ö‡∏≤‡∏ó)\n`);
    text += `‡∏£‡∏ß‡∏°: ${r.total} ‡∏ö‡∏≤‡∏ó\n`;
  });
  historyDiv.textContent = text;
  reportDiv.textContent = "";
}

function exportCSV() {
  if (historyData.length === 0) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    return;
  }
  let csv = "‡πÇ‡∏ï‡πä‡∏∞,‡πÄ‡∏ß‡∏•‡∏≤,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°\n";
  historyData.forEach(r => {
    const items = r.items.map(i => i.name).join(" + ");
    csv += `${r.table},"${r.time}","${items}",${r.total}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "pos_jer_nong.csv";
  link.click();
}

function showReport() {
  if (historyData.length === 0) {
    reportDiv.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    return;
  }
  const summary = {};
  historyData.forEach(r => {
    if (!summary[r.table]) summary[r.table] = 0;
    summary[r.table] += r.total;
  });
  let text = "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÇ‡∏ï‡πä‡∏∞:\n";
  Object.entries(summary).forEach(([table, total]) => {
    text += `‡πÇ‡∏ï‡πä‡∏∞ ${table}: ${total} ‡∏ö‡∏≤‡∏ó\n`;
  });
  reportDiv.textContent = text;
  historyDiv.textContent = "";
}

function saveOrder() {
  const tableNo = tableInput.value.trim();
  if (!tableNo || order.length === 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
    return;
  }
  pendingOrders[tableNo] = [...order];
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏ï‡πä‡∏∞ " + tableNo + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
}

function loadOrderByTable(tableNo) {
  if (!pendingOrders[tableNo]) return;
  order = [...pendingOrders[tableNo]];
  tableInput.value = tableNo;
  updateTotal();
}

function showPendingOrders() {
  const keys = Object.keys(pendingOrders);
  const pendingDiv = document.getElementById("pendingList");
  if (keys.length === 0) {
    pendingDiv.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ";
    return;
  }
  let html = "üìã ‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:<br>";
  keys.forEach(table => {
    html += `<button onclick="loadOrderByTable('${table}')">‡πÇ‡∏ï‡πä‡∏∞ ${table}</button> `;
  });
  pendingDiv.innerHTML = html;
}
</script>
</body>
</html>
